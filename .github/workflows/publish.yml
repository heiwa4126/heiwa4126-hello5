name: Publish to npm
# Direct publishing to npmjs from GitHub using pnpm and npm with OIDC Trusted Publishing
on:
  push:
    tags:
      # 通常リリース: 例) v1.2.3
      - "v[0-9]+.[0-9]+.[0-9]+"
      # プリリリースのみ: 例) v1.2.3-rc.1, v1.2.3-beta など(必ず '-' が付く)
      - "v[0-9]+.[0-9]+.[0-9]+-*"

defaults:
  run:
    shell: bash

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  osv-scan:
    # Only run if pushed by repository owner
    if: github.repository_owner == github.actor
    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable.yml@375a0e8ebdc98e99b02ac4338a724f5750f21213 # v2.3.1
    permissions:
      actions: read # reusable workflow の実行に必要
      security-events: write # 脆弱性スキャン結果(SARIF形式)を  GitHub の Security タブにアップロードするために必要
      contents: read # リポジトリの内容を読み取るために必要
    with:
      scan-args: "-L ./pnpm-lock.yaml"

  publish:
    # Only run if pushed by repository owner and after OSV scan passes
    if: github.repository_owner == github.actor
    needs: osv-scan
    runs-on: ubuntu-latest
    environment: npmjs
    permissions:
      contents: read
      # contents: write # for releases
      id-token: write # OIDC に必須
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: latest
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: latest
          cache: pnpm

      - name: (DEBUG) Show versions of Node.js, npm, and pnpm
        run: node -v && npm -v && pnpm -v
      # - name: (DEBUG) Show .npmrc
      #   run: cat "${NPM_CONFIG_USERCONFIG}"

      - name: Install dependencies (pnpm install)
        run: pnpm install --frozen-lockfile

      # - run: npm run build --if-present
      # - run: npm test
      ## このプロジェクトでは prepublishOnly に書いてあるので不要

      - name: Publish to npm via OIDC (Trusted publishing)
        run: |
          if [[ $GITHUB_REF_NAME == *-* ]]; then
            npm publish --access public --tag dev
          else
            npm publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: "" # 念のため

# # おまけ。releases にもtgzをアップロードする
# - name: build package
#   run: pnpm run build
# - name: Pack package tarball
#   run: pnpm pack
# - name: Create GitHub Release
#   uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
#   with:
#     files: ./*.tgz
#     generate_release_notes: true
#     prerelease: ${{ contains(github.ref_name, '-') }}
#   env:
#     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
